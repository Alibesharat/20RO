@model DAL.ServiceRequset
@{
    ViewData["Title"] = "جزییات درخواست";

    var data = ViewData["navigation"];

}


<div class="row">
    <div class="col s12 ">
        <div class="card">
            <div class="card-map">
                <div id='map'>

                </div>
            </div>
            <div class="card-content">
                <p></p>
            </div>

        </div>
    </div>
    <div class="col s12 ">
        <div class="card">
           
            <div class="card-content">
                @if (Model.RequsetState == RequsetSate.Servicing)
                {
                    
                        var item = Model.cabAsFirst ?? Model.cabAsSecond ?? Model.cabAsThird ?? Model.cabAsFourth;
                        <div class="row">
                            <div class="col s12 m4">
                                <div class="row">
                                    <span class="btn contant">
                                        @item?.Driver.FullName
                                    </span>
                                </div>
                                <div class="row">
                                    <span class="btn contant">
                                        <a href="tel:@item?.Driver.PhoneNubmber">
                                            تماس با راننده
                                        </a>

                                    </span>
                                </div>
                                <div class="row">
                                    <span class="btn contant">
                                        @item?.Driver.CarName - @item.Driver.CarColor  @item.Driver?.PelakNumber
                                    </span>
                                </div>


                            </div>

                            <div class="col s12 m4 left">
                                <p class="center">
                                    <img class="img-circle " src="~/Dynamics/Drivers/@item.Driver.AvatarPath" width="130" height="130" />

                                </p>
                            </div>
                        </div>
                   

                    <hr />
                }




                <div class="row">
                    <div class="col s12 m8">
                        <span class="btn contant">
                            <span class="small-info">آموزشگاه  @Model.course.Academy.Name</span>  @Model.course.Academy.Address
                        </span>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m3">
                        <span class="btn contant">
                            <span class="large-info">   مسافت </span>    @Model.Distance  کیلومتر
                        </span>
                    </div>
                </div>

                <div class="row">
                    <div class="col s12 m3">
                        <span class="btn contant">
                            <span class="small-info">وضعیت سرویس :</span> @Html.DisplayFor(c => c.RequsetState)
                        </span>
                    </div>
                </div>
                <div class="row">
                    <div class="col s12 m3">
                        <span class="btn contant">
                            <span class="small-info"> هزینه یک ترم تحصیلی  :</span> @((Model.price / 10).ToString("N0")) تومان
                        </span>
                    </div>
                </div>




                @if (Model.RequsetState == RequsetSate.AwaitingPayment)
                {
                    <p class="center">
                        <button class="btn waves-effect waves-light Red lighten-5 " onclick="pay()"> تایید و پرداخت </button>
                    </p>
                    <br>
                    <p class="center">
                        <button class="btn waves-effect waves-light green lighten-2 " onclick="location.href = '/';"> لغو درخواست </button>

                    </p>
                }



            </div>

        </div>
    </div>
</div>
            

@section Scripts{
    <script src="~/js/mapbox.js"></script>
    <script>

        $(document).ready(function () {
          
            var routedata = {
                origin: "@Model.Origin",
                Distination: "@Model.Distination",
            }
            $.ajax({
                type: "POST",
                url: '@Url.Action("GetRoute", "Home")',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data:  JSON.stringify(routedata),
                success: function (response) {
                    addlayer(response);
                    addIndicator(response);
                    console.log(response.coordinates[0]);
                 

                },
                failure: function (response) {
                    console.log(response);

                },
            });
        });


        function addlayer(response) {
            map.addLayer({
                "id": "route",
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": response
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "square",
                     
                    
                },
                "paint": {
                    "line-color": "#3887be",
                    "line-width": 8,

                }
            });
            map.addLayer({
                id: 'routearrows',
                type: 'symbol',
                source: 'route',
                layout: {
                    'symbol-placement': 'line',
                    'text-field': '▶',
                    'text-size': {
                        base: 1,
                        stops: [[12, 24], [22, 60]]
                    },
                    'symbol-spacing': {
                        base: 1,
                        stops: [[12, 30], [22, 160]]
                    },
                    'text-keep-upright': false
                },
                paint: {
                    'text-color': '#3887be',
                    'text-halo-color': 'hsl(55, 11%, 96%)',
                    'text-halo-width': 3
                }
            });
           
           

            // Geographic coordinates of the LineString
            var coordinates = response.coordinates;
        
            // Pass the first coordinates in the LineString to `lngLatBounds` &
            // wrap each coordinate pair in `extend` to include them in the bounds
            // result. A variation of this technique could be applied to zooming
            // to the bounds of multiple Points or Polygon geomteries - it just
            // requires wrapping all the coordinates with the extend method.
            var bounds = coordinates.reduce(function (bounds, coord) {
                return bounds.extend(coord);
            }, new mapboxgl.LngLatBounds(coordinates[0], coordinates[1]));

            map.fitBounds(bounds);
            
        }

        function addIndicator(response)
        {
            
            var start = response.coordinates[0];
            var end = response.coordinates[response.coordinates.length - 1];
            map.loadImage('../statatics/icons/Circle_Yellow.png', function (error, image) {
                if (error) throw error;
                map.addImage('icon', image);
            });
            map.addLayer({
                "id": 'start',
                "type": "symbol",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [start[0], start[1]]
                            }
                        }]
                    }
                },

                "layout": {

                    "icon-image": 'icon',
                    "icon-size": 0.2,
                    "text-field": 'مبدا',
                    "text-font": [
                       
          "Open Sans Semibold",
          "Arial Unicode MS Bold"
                    ],
                    "text-size": 12
                }
            });
            map.addLayer({
                "id": 'end',
                "type": "symbol",
                "source": {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [end[0], end[1]]
                            }
                        }]
                    }
                },

                "layout": {

                    "icon-image": 'icon',
                    "icon-size": 0.2,
                    "text-field": 'مقصد',
                    "text-font": [
         "Open Sans Semibold",
         "Arial Unicode MS Bold"
                    ],
                    "text-size": 12
                }
            });
        }
        



        function pay()
        {

            LoadingStart();
            var paydata = {
                ParrentId: '1',
                requsetId:'@Model.Id'
            }
            $.ajax({
                type: "POST",
                url: '@Url.Action("pay", "Home")',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify(paydata),
                success: function (response) {
                    LoadingEnd();
                    if (response.statuse == false) {
                        ShowMessage(response.message);
                    } else {
                        location.replace(response.data);
                    }


                },
                failure: function (response) {
                    console.log(response);
                    LoadingEnd();
                    ShowMessage("خطایی بوجودآمد");
                   
                },
            });
        }
    </script>
}